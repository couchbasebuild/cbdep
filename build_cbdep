#!/bin/bash -ex

pushd `dirname $0` > /dev/null
SCRIPTPATH=`pwd -P`
popd > /dev/null

echo Setting up Python virtual environment
BUILDDIR="$(pwd)/build"
mkdir -p "${BUILDDIR}"
python3 -m venv "${BUILDDIR}/venv"
. "${BUILDDIR}/venv/bin/activate"

# for now we have a modified version of pyinstaller, so we have to build
# the bootloader and then pip it from there. Except on MacOS x86_64,
# where this will build but then attempt to notarize and fail, so we
# use an old version.
if [[ "${ARCH}" == "x86_64" && "${PLATFORM}" == "darwin" ]]; then
    pip3 install pyinstaller==4.2
else
    pushd ${SCRIPTPATH}/../pyinstaller/bootloader
    python waf all
    git status
    cd ..
    pip3 install wheel && pip install .
    popd
fi

echo Installing cbdep requirements
pip3 install -r ${SCRIPTPATH}/requirements.txt

# Customize _buildversion.py if build info available in environment
if [ ! -z "${VERSION}" -a ! -z "${BLD_NUM}" ]; then
    VERSIONPATH="${BUILDDIR}/version"
    mkdir -p "${VERSIONPATH}"
    cat <<EOF > "${VERSIONPATH}/_buildversion.py"
__version__ = "${VERSION}"
__build__ = "${BLD_NUM}"
EOF
else
    VERSIONPATH=""
fi

echo Compiling cbdep
PYINSTDIR=$(pwd)/build/pyinstaller
mkdir -p ${PYINSTDIR}
pyinstaller --log-level DEBUG \
    --add-data ${SCRIPTPATH}/cbdep.config:. \
    --workpath ${PYINSTDIR} \
    --specpath ${PYINSTDIR} \
    --distpath dist --noconfirm \
    --onefile --clean \
    --paths "${VERSIONPATH}:${SCRIPTPATH}/cbdep/scripts" \
    ${SCRIPTPATH}/cbdep/scripts/cbdep.py
